<!DOCTYPE html>
<html lang="en-us"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Pinebook Pro Custom Kernel | Peters Website</title>
<meta property="og:title" content="Pinebook Pro Custom Kernel | Peters Website" />
<meta name="twitter:title" content="Pinebook Pro Custom Kernel | Peters Website" />
<meta itemprop="name" content="Pinebook Pro Custom Kernel | Peters Website" />
<meta name="application-name" content="Pinebook Pro Custom Kernel | Peters Website" />
<meta property="og:site_name" content="Peter&#39;s blog" />

<meta name="description" content="Random blog posts...some techy and some not">
<meta itemprop="description" content="Random blog posts...some techy and some not" />
<meta property="og:description" content="Random blog posts...some techy and some not" />
<meta name="twitter:description" content="Random blog posts...some techy and some not" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />



  <meta itemprop="image" content="https://peterunix.github.io/" />
  <meta property="og:image" content="https://peterunix.github.io/" />
  <meta name="twitter:image" content="https://peterunix.github.io/" />
  <meta name="twitter:image:src" content="https://peterunix.github.io/" />




    
    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2023-07-22T15:57:39-0700 />
    <meta property="article:published_time" content=2023-07-22T15:57:39-0700 />

    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Pinebook Pro Custom Kernel",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2023-07-22",
        "description": "",
        "wordCount":  476 ,
        "mainEntityOfPage": "True",
        "dateModified": "2023-07-22",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "Peters Website"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.115.4">

    

    <link rel="canonical" href="https://peterunix.github.io/posts/pinebook-pro-custom-kernel/">
    <link href="/style.min.d16f523c36741e07697791cfe4bcb09b8c92c7034d5cbf85980df65d92a70e97.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="https://peterunix.github.io/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    </head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="https://peterunix.github.io/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        About
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Pinebook Pro Custom Kernel</h1>
                
                
                <div class="post-meta">
                    <time datetime="2023-07-22T15:57:39-07:00" itemprop="datePublished"> 22 Jul 2023 </time>
                </div>
                
            </header>
            <details class="toc">
                <summary><b>Table of Contents</b></summary>
                <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">Preface</a>
</li>
<li><a href="#headline-2">Setting up our enviroment</a>
</li>
<li><a href="#headline-3">Compiling the kernel</a>
</li>
<li><a href="#headline-4">Installing the packages files</a>
</li>
<li><a href="#headline-5">Uboot (IMPORTANT)</a>
</li>
<li><a href="#headline-6">Encryption</a>
</li>
</ul>
</nav>
            </details><div class="page-content">
                
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Preface
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>Here&#39;s how to compile <a href="https://gitlab.manjaro.org/tsys/linux-pinebook-pro">tsys&#39;</a> mainline linux kernel for the Pinebook Pro.
I&#39;m using the &#34;debian way&#34; of installing the kernel.
When compiling the kernel, we can tell &#34;make&#34; to package the binaries as multiple debian archive files (.deb).
Afterward, we can simple run &#34;dpkg -i .deb&#34; to install it.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Setting up our enviroment
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>Here we&#39;ll download the dependencies and the linux sources.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt-get install linux-headers-<span class="k">$(</span>uname -r<span class="k">)</span> libncurses-dev gawk flex bison openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf bc fakeroot
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Linux sources</span>
</span></span><span class="line"><span class="cl">git clone --depth<span class="o">=</span><span class="m">1</span> https://gitlab.manjaro.org/tsys/linux-pinebook-pro
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> linux-pinebook-pro</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Compiling the kernel
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>The &#34;ARCH&#34; variable specifies the target machines architecture.</p>
<p>
The &#34;CROSS_COMPILE&#34; variable specifies which compiler the system should use.</p>
<p>
Running &#34;make menuconfig&#34; opens an ncurses menu which you can use to modify the kernel.
You don&#39;t need to change anything.
Run the command and exit the ncurses menu to save the kernel configuration to &#34;$PWD/.config&#34;</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ARCH</span><span class="o">=</span>arm64
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Exit the ncurses menu to save the default config</span>
</span></span><span class="line"><span class="cl">make -j <span class="m">6</span> menuconfig
</span></span><span class="line"><span class="cl">make -j <span class="m">6</span> deb-pkg</span></span></code></pre></div>
</div>
<p>
The compiling process should take about two hours. My pinebook was left on a desk and stayed consistently at 68.4-69.8 degrees Celsius.
The output deb files are in &#34;../&#34;</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
Installing the packages files
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>I forgot the exact names of the output deb files.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo dpkg -i linux-headers-*.deb
</span></span><span class="line"><span class="cl">sudo dpkg -i linux-image-*.deb
</span></span><span class="line"><span class="cl">sudo dpkg -i linux-libc-*.deb</span></span></code></pre></div>
</div>
<p>
<strong>DON&#39;T REBOOT YET!</strong> It turns out that uboot, at least from the debian
installer, isn&#39;t compiled with a gzip decompressor.
If you haven&#39;t noticed, your linux kernel and initrd are actually both
gzip archives!
This confused the heck out of me at first. You&#39;ll need to decompress the files and put them back in /boot</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># We need to rename them with the suffix &#34;.gz&#34; or else gzip returns errors</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ~
</span></span><span class="line"><span class="cl">mv /boot/vmlinuz-5.10.0-rc5-1-pinebookpro-arm64+ ~/vmlinuz-5.10.0-rc5-1-pinebookpro-arm64+.gz
</span></span><span class="line"><span class="cl">gzip -d ~/vmlinuz-5.10.0-rc5-1-pinebookpro-arm64+.gz
</span></span><span class="line"><span class="cl">mv ~/vmlinuz-5.10.0-rc5-1-pinebookpro-arm64+ /boot/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mv /boot/initrd.img-5.10.0-rc5-1-pinebookpro-arm64+ ~/initrd.img-5.10.0-rc5-1-pinebookpro-arm64+.gz
</span></span><span class="line"><span class="cl">gzip -d ~/initrd.img-5.10.0-rc5-1-pinebookpro-arm64+.gz
</span></span><span class="line"><span class="cl">mv ~/initrd.img-5.10.0-rc5-1-pinebookpro-arm64+</span></span></code></pre></div>
</div>
<p>
<strong>DONE!</strong> You can boot into your new mainline kernel now.</p>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
Uboot (IMPORTANT)
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>
Remove &#34;maxcpus=4&#34; from /boot/extlinux/extlinux.conf</p>
<p>
This option was automatically added and is supposed to make boot times
faster.
Just remove it from the uboot config. The boot times are fine without
it and are infact LONGER if you keep it.</p>
<p>
FYI: Normally the default kernel re-enables the two large cores once
it&#39;s booted. For some reason this one does not.</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">## /boot/extlinux/extlinux.conf
</span></span><span class="line"><span class="cl">default 10
</span></span><span class="line"><span class="cl">menu title U-Boot menu
</span></span><span class="line"><span class="cl">prompt 0
</span></span><span class="line"><span class="cl">timeout 10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">label l0
</span></span><span class="line"><span class="cl">        menu label Debian GNU/Linux bullseye/sid 5.10.0-rc5-1-pinebookpro-arm64+
</span></span><span class="line"><span class="cl">        linux /vmlinuz-5.10.0-rc5-1-pinebookpro-arm64+
</span></span><span class="line"><span class="cl">        initrd /initrd.img-5.10.0-rc5-1-pinebookpro-arm64+
</span></span><span class="line"><span class="cl">        fdt /rk3399-pinebook-pro.dtb
</span></span><span class="line"><span class="cl">        append root=PARTLABEL=mmcblk1-RootFS console=ttyS2,1500000n8 console=tty0 ro quiet splash plymouth.ignore-serial-consoles maxcpus=6 coherent_pool=1M</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
Encryption
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>I couldn&#39;t boot from my encrypted debian install.
According to <a href="https://forum.pine64.org/showthread.php?tid=8765">this post</a>, you can update your initrd to include modules to decrypt the file system, but the display won&#39;t work.
I couldn&#39;t even get a prompt to appear using the serial console when attempting this.
I&#39;m opting for an encrypted home partition instead.</p>
</div>
</div>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/peterunix" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        Â© 2023 Peter T.
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noreferrer noopener">Hugo blog awesome</a>
        theme on
        <a href="https://gohugo.io" target="_blank" rel="noreferrer noopener">Hugo</a>.
    </small>
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script src="https://peterunix.github.io/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js" integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30&#43;lSNuSkl4QXuNyy8="></script>

    

</body>
</html>

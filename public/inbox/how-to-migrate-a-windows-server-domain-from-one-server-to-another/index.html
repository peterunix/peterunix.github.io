<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
  <title>How to Migrate a Windows Server Domain From One Server to Another</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/gtd.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/prism.min.js"></script>
</head>
<body>
  
<main>
  <div style="margin: 1rem;">
    <a href="/" style="
      display: inline-block;
      background-color: #eee;
      color: #333;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      font-family: sans-serif;
      font-size: 0.9rem;
    ">
      ‚Üê Homepage
    </a>

  <h1>How to Migrate a Windows Server Domain From One Server to Another</h1>

  </div>
  <nav class="toc">
    <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">Preface</a>
</li>
<li><a href="#headline-2">Check the DC Health</a>
</li>
<li><a href="#headline-3">Join New Server to Domain</a>
</li>
<li><a href="#headline-4">Install AD Services Role</a>
</li>
<li><a href="#headline-5">Promote the Server to a Domain Controller</a>
</li>
<li><a href="#headline-6">Transfer FSMO Roles</a>
</li>
<li><a href="#headline-7">Force Replication</a>
</li>
<li><a href="#headline-8">Checking that everything works</a>
</li>
<li><a href="#headline-9">Demote the Domain</a>
</li>
<li><a href="#headline-10">Remove Static Addresses From Workstations</a>
</li>
</ul>
</nav>
  </nav> 

  <article>
    
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Preface
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>This guide assumes you&#39;re migrating a domain controller to a new
server then demoting the old DC.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Check the DC Health
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>On the old server, run a few reports and make sure the health of the
domain controller is good. Fix any errors that arise prior to
migrating anything.</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dcdiag.exe /v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dcdiag.exe /test<span style="color:#960050;background-color:#1e0010">:</span>dns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>repadmin.exe /replsummary</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Join New Server to Domain
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<p>Make sure your DNS is pointing to the old DC before doing this.</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Add-Computer -DomainName DOMAINNAME.local -Restart</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
Install AD Services Role
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>This will install Active Directory and all that good stuff</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools
</span></span><span style="display:flex;"><span>Restart-Computer</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
Promote the Server to a Domain Controller
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>Figured promoting the DC using a powershell command would be more
fun : )</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$HashArguments = @{
</span></span><span style="display:flex;"><span>    Credential = (Get-Credential <span style="color:#e6db74">&#34;DOMAINNAME\Administrator&#34;</span>)
</span></span><span style="display:flex;"><span>    DomainName = <span style="color:#e6db74">&#34;DOMAINNAME.local&#34;</span>
</span></span><span style="display:flex;"><span>    InstallDns = $true
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Install-ADDSDomainController @HashArguments</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
Transfer FSMO Roles
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>Run these commands on the old server. This will transfer all the
fancy pants FSMO rules to the new domain controller. Later we&#39;re going
to decommission the old server so we want to make sure these roles are transferred.</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ntdsutil
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C:\Windows\system32\ntdsutil.exe<span style="color:#960050;background-color:#1e0010">:</span> roles
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> connections
</span></span><span style="display:flex;"><span>server connections<span style="color:#960050;background-color:#1e0010">:</span> connect to server NEW_DC_NAME
</span></span><span style="display:flex;"><span>Binding to server...
</span></span><span style="display:flex;"><span>Connected to server using credentials of locally logged on user.
</span></span><span style="display:flex;"><span>server connections<span style="color:#960050;background-color:#1e0010">:</span> q
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> transfer infrastructure master
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> transfer naming master
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> transfer pdc
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> transfer rid master
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> transfer schema master
</span></span><span style="display:flex;"><span>fsmo maintenance<span style="color:#960050;background-color:#1e0010">:</span> q
</span></span><span style="display:flex;"><span>C:\Windows\system32\ntdsutil.exe<span style="color:#960050;background-color:#1e0010">:</span> q</span></span></code></pre></div>
</div>
<p>
On the new server verify that the FSMO roles were transferred using
this command</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>netdom query fsmo</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
Force Replication
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<p>This should replicate the data from the old DC to the new DC automatically.</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>repadmin /syncall /AdeP</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-8" class="outline-2">
<h2 id="headline-8">
Checking that everything works
</h2>
<div id="outline-text-headline-8" class="outline-text-2">
<p>On the new domain controller, pull some reports and make sure there&#39;s
no errors. Make sure that replication is working perfectly using repadmin.exe</p>
<p>
Your new server should also have the SYSVOL and NETLOGIN shares
automatically created on it. Make sure those exist.</p>
<p>
If you&#39;re having problems with the replication succeeding but the
SYSVOL and NETLOGIN shares not being created, it could be caused by
the old domain controller still trying to replicate to an even older
DC thats no longer in place. I had a problem where a server was
migrated once before and the new DC was still thinking it was a
replication target. Since the OG server was already decomissioned, the
current DC thought it had stale data and refused to replicate to the
new DC. I followed <a href="https://www.rmtechteam.com/blog/dfs-replication-dfsr-fix/#:~:text=To%20resume%20replication%20of%20this,members%20of%20the%20replication%20group">this tutorial</a> to fix it.</p>
<p>
<strong>Read the DFRS Event Log for in &#34;Applications and Services Logs\DFS Replication&#34;</strong></p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dcdiag.exe /v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dcdiag.exe /test<span style="color:#960050;background-color:#1e0010">:</span>dns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>repadmin.exe /replsummary</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-2">
<h2 id="headline-9">
Demote the Domain
</h2>
<div id="outline-text-headline-9" class="outline-text-2">
<p>When everything is looking good, you can demote the old domain
controller. You should be good to go</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>DCPROMO.EXE</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-10" class="outline-2">
<h2 id="headline-10">
Remove Static Addresses From Workstations
</h2>
<div id="outline-text-headline-10" class="outline-text-2">
<p>This powershell script will set all the network cards DNS to
DHCP. Make sure you already configured your router with the IP of the
new DNS server.</p>
<div class="src src-powershell">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetAdapter | Where-Object {$_.Status <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#39;Up&#39;</span>} | <span style="color:#66d9ef">foreach</span> {
</span></span><span style="display:flex;"><span>    $InterfaceAlias = $_.InterfaceAlias
</span></span><span style="display:flex;"><span>    Set-DnsClientServerAddress -InterfaceAlias $InterfaceAlias -ResetServerAddresses
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
</div>
</div>
</div>

  </article>
</main>

</body>
</html>
